---
// Layout principal refactorizado con mejores prácticas de accesibilidad
// Single Responsibility: Estructura base de todas las páginas
// Dependency Inversion: Usa componentes abstractos

import Logo from "../components/Logo.astro";
import { MoreVertical } from "lucide-static";
import { ViewTransitions } from 'astro:transitions';

export interface Props {
  title: string;
  description?: string;
  type?: 'website' | 'article';
  image?: string;
}

const {
  title,
  description = "Sitio web de Muga OS. Explora nuestro blog, ideas y proyectos relacionados con el sistema operativo Muga OS.",
  type = 'website',
  image = '/favicon.svg'
} = Astro.props;

const currentPath = Astro.url.pathname;
const canonicalURL = Astro.site ? new URL(Astro.url.pathname, Astro.site) : Astro.url.href;
---

<!doctype html>
<html lang="es" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- SEO Meta Tags -->
    <title>{title}</title>
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content={type} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:image" content={image.startsWith('http') ? image : `${Astro.site || 'http://localhost:4321'}${image}`} />
    <meta property="og:site_name" content="MUGA OS" />
    <meta property="og:locale" content="es_ES" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={image.startsWith('http') ? image : `${Astro.site || 'http://localhost:4321'}${image}`} />
    
    <link rel="canonical" href={canonicalURL} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    
    <!-- Preload critical resources -->
    <link rel="preload" href="/favicon.svg" as="image" type="image/svg+xml" />
    
    <!-- Theme color for mobile browsers -->
    <meta name="theme-color" content="#0a0a0a" />
    <meta name="color-scheme" content="dark" />
    
    <!-- View Transitions -->
    <ViewTransitions />
    
    <!-- Prefetch DNS for external resources -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com" />
  </head>
  <body
    class="bg-neutral-950 text-white min-h-screen scrollbar-thin scrollbar-thumb-neutral-700 scrollbar-track-neutral-900"
  >
    <!-- Skip to main content link for accessibility -->
    <a 
      href="#main-content" 
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-white text-black px-4 py-2 z-50 focus:outline-none focus:ring-2 focus:ring-white"
    >
      Saltar al contenido principal
    </a>

    <header class="bg-neutral-950" role="banner">
      <nav class="max-w-6xl mx-auto px-6 py-6" role="navigation" aria-label="Navegación principal">
        <div class="flex items-center justify-between">
          <a 
            href="/" 
            class="hover:opacity-80 transition-opacity focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-neutral-950"
            aria-label="Ir al inicio - MUGA OS"
          >
            <Logo />
          </a>
          <button
            id="menu-toggle"
            class="relative text-neutral-400 hover:text-white transition-colors focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-neutral-950 w-6 h-6"
            aria-label="Abrir menú de navegación"
            aria-expanded="false"
            aria-controls="full-menu"
          >
            <span
              id="menu-icon"
              set:html={MoreVertical.replace("<svg", '<svg class="w-6 h-6 transition-opacity duration-200"')}
              class="inline-block"
              aria-hidden="true"
            />
            <span
              id="close-icon"
              class="absolute inset-0 text-4xl leading-none opacity-0 transition-opacity duration-200 flex items-center justify-center"
              aria-hidden="true"
            >
              ×
            </span>
          </button>
        </div>
      </nav>
    </header>

    <!-- Full-screen menu -->
    <div
      id="full-menu"
      class="fixed inset-0 bg-black z-50 opacity-0 invisible transition-all duration-300 ease-in-out flex items-center justify-center"
      role="dialog"
      aria-modal="true"
      aria-labelledby="menu-title"
      aria-hidden="true"
    >
      <!-- Background overlay -->
      <div class="absolute inset-0 bg-black bg-opacity-90 backdrop-blur-md"></div>
      
      <!-- Menu content -->
      <div class="relative text-center transform scale-95 transition-transform duration-300 ease-in-out">
        <h2 id="menu-title" class="sr-only">Menú de navegación</h2>
        
        <nav class="space-y-8" role="navigation" aria-label="Menú principal">
          <a
            href="/"
            class="block text-white text-2xl uppercase tracking-wide hover:text-neutral-300 transition-colors focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-black"
            aria-current={currentPath === '/' ? 'page' : undefined}
          >
            Inicio
          </a>
          <a
            href="/blog"
            class="block text-white text-2xl uppercase tracking-wide hover:text-neutral-300 transition-colors focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-black"
            aria-current={currentPath === '/blog' ? 'page' : undefined}
          >
            Blog
          </a>
          <a
            href="/articles"
            class="block text-white text-2xl uppercase tracking-wide hover:text-neutral-300 transition-colors focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-black"
            aria-current={currentPath === '/articles' ? 'page' : undefined}
          >
            Artículos
          </a>
          <a
            href="/ideas"
            class="block text-white text-2xl uppercase tracking-wide hover:text-neutral-300 transition-colors focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-black"
            aria-current={currentPath === '/ideas' ? 'page' : undefined}
          >
            Ideas
          </a>
          <a
            href="/projects"
            class="block text-white text-2xl uppercase tracking-wide hover:text-neutral-300 transition-colors focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-black"
            aria-current={currentPath === '/projects' ? 'page' : undefined}
          >
            Proyectos
          </a>
        </nav>
      </div>
    </div>

    <main id="main-content" class="max-w-6xl mx-auto" role="main">
      <slot />
    </main>

    <footer class="bg-neutral-950 mt-16" role="contentinfo">
      <div class="max-w-4xl mx-auto px-6 py-8 text-center">
        <p class="text-neutral-600 text-xs uppercase tracking-wide mb-2">
          2026 MUGA OS.
        </p>
        <p class="text-neutral-700 text-xs">1.2.6</p>
      </div>
    </footer>

    <script>
      // Manejo del menú con mejores prácticas de accesibilidad y transiciones suaves
      let cleanupMenu: (() => void) | null = null;
      let cleanupPrefetch: (() => void) | null = null;

      const setupInteractions = () => {
        cleanupMenu?.();
        cleanupPrefetch?.();

        cleanupMenu = initializeMenu();
        cleanupPrefetch = initializePrefetch();
      };

      document.addEventListener('DOMContentLoaded', setupInteractions);
      document.addEventListener('astro:after-swap', setupInteractions);

      function initializeMenu() {
        const menuToggle = document.getElementById("menu-toggle");
        const fullMenu = document.getElementById("full-menu");
        const menuIcon = document.getElementById("menu-icon");
        const closeIcon = document.getElementById("close-icon");
        const menuContent = fullMenu?.querySelector('.relative');
        const menuLinks = fullMenu?.querySelectorAll("a");

        if (!menuToggle || !fullMenu || !menuIcon || !closeIcon) return () => {};

        let isMenuOpen = false;

        // Función para abrir el menú
        const openMenu = () => {
          if (isMenuOpen) return;

          isMenuOpen = true;

          // Prevenir layout shift
          document.body.style.paddingRight = `${window.innerWidth - document.documentElement.clientWidth}px`;
          document.body.style.overflow = 'hidden';

          fullMenu.classList.remove("invisible");
          fullMenu.setAttribute("aria-hidden", "false");
          menuToggle.setAttribute("aria-expanded", "true");

          // Cambiar iconos
          menuIcon.style.opacity = '0';
          closeIcon.style.opacity = '1';

          // Animar entrada del menú
          requestAnimationFrame(() => {
            fullMenu.classList.remove("opacity-0");
            fullMenu.classList.add("opacity-100");
            if (menuContent) {
              menuContent.classList.remove("scale-95");
              menuContent.classList.add("scale-100");
            }
          });

          // Enfocar el primer enlace para accesibilidad
          setTimeout(() => {
            const firstLink = menuLinks?.[0] as HTMLElement;
            firstLink?.focus();
          }, 150);
        };

        // Función para cerrar el menú
        const closeMenu = () => {
          if (!isMenuOpen) return;

          isMenuOpen = false;

          // Cambiar iconos
          menuIcon.style.opacity = '1';
          closeIcon.style.opacity = '0';

          // Animar salida del menú
          fullMenu.classList.remove("opacity-100");
          fullMenu.classList.add("opacity-0");
          if (menuContent) {
            menuContent.classList.remove("scale-100");
            menuContent.classList.add("scale-95");
          }

          // Después de la animación, ocultar completamente
          setTimeout(() => {
            fullMenu.classList.add("invisible");
            fullMenu.setAttribute("aria-hidden", "true");
            menuToggle.setAttribute("aria-expanded", "false");

            // Restaurar scroll del body
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';

            // Devolver focus al botón toggle
            menuToggle.focus();
          }, 300);
        };

        // Event listeners
        const handleToggle = () => {
          if (isMenuOpen) {
            closeMenu();
          } else {
            openMenu();
          }
        };
        menuToggle.addEventListener("click", handleToggle);

        const linkHandlers: Array<{ el: Element; handler: () => void }> = [];

        // Cerrar menú al hacer clic en los enlaces
        menuLinks?.forEach((link) => {
          const handler = () => closeMenu();
          link.addEventListener("click", handler);
          linkHandlers.push({ el: link, handler });
        });

        // Cerrar menú al hacer clic en el overlay
        const handleOverlayClick = (e: Event) => {
          if (e.target === fullMenu || e.target === fullMenu.querySelector('.absolute')) {
            closeMenu();
          }
        };
        fullMenu.addEventListener("click", handleOverlayClick);

        // Cerrar menú con Escape
        const handleEscape = (e: KeyboardEvent) => {
          if (e.key === "Escape" && isMenuOpen) {
            closeMenu();
          }
        };
        document.addEventListener("keydown", handleEscape);

        // Trap focus dentro del menú cuando está abierto
        const handleTrapFocus = (e: KeyboardEvent) => {
          if (!isMenuOpen) return;

          if (e.key === "Tab") {
            const focusableElements = fullMenu.querySelectorAll(
              'button, a, input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstElement = focusableElements[0] as HTMLElement;
            const lastElement = focusableElements[focusableElements.length - 1] as HTMLElement;

            if (e.shiftKey && document.activeElement === firstElement) {
              e.preventDefault();
              lastElement?.focus();
            } else if (!e.shiftKey && document.activeElement === lastElement) {
              e.preventDefault();
              firstElement?.focus();
            }
          }
        };
        fullMenu.addEventListener("keydown", handleTrapFocus);

        return () => {
          closeMenu();
          menuToggle.removeEventListener("click", handleToggle);
          fullMenu.removeEventListener("click", handleOverlayClick);
          document.removeEventListener("keydown", handleEscape);
          fullMenu.removeEventListener("keydown", handleTrapFocus);
          linkHandlers.forEach(({ el, handler }) => el.removeEventListener("click", handler));
        };
      }

      function initializePrefetch() {
        const prefetchedUrls = new Set();
        const handlers: Array<{ el: Element; onEnter: () => void; onLeave: () => void; onFocus: () => void; onBlur: () => void }> = [];

        // Función para prefetch de una URL
        const prefetchUrl = (url: string) => {
          if (prefetchedUrls.has(url)) return;

          prefetchedUrls.add(url);
          const link = document.createElement('link');
          link.rel = 'prefetch';
          link.href = url;
          document.head.appendChild(link);
        };

        // Agregar listeners a todos los enlaces internos
        const internalLinks = document.querySelectorAll('a[href^="/"], a[href^="./"], a[href^="../"]');

        internalLinks.forEach((link) => {
          const href = link.getAttribute('href');
          if (!href || href === '#' || href.startsWith('#')) return;

          let prefetchTimeout: number;

          const onEnter = () => {
            // Delay pequeño para evitar prefetch accidental
            prefetchTimeout = window.setTimeout(() => {
              prefetchUrl(href);
            }, 100);
          };
          link.addEventListener('mouseenter', onEnter);

          const onLeave = () => {
            clearTimeout(prefetchTimeout);
          };
          link.addEventListener('mouseleave', onLeave);

          // También prefetch en focus para navegación por teclado
          const onFocus = () => {
            prefetchTimeout = window.setTimeout(() => {
              prefetchUrl(href);
            }, 200);
          };
          link.addEventListener('focus', onFocus);

          const onBlur = () => {
            clearTimeout(prefetchTimeout);
          };
          link.addEventListener('blur', onBlur);

          handlers.push({ el: link, onEnter, onLeave, onFocus, onBlur });
        });

        return () => {
          handlers.forEach(({ el, onEnter, onLeave, onFocus, onBlur }) => {
            el.removeEventListener('mouseenter', onEnter);
            el.removeEventListener('mouseleave', onLeave);
            el.removeEventListener('focus', onFocus);
            el.removeEventListener('blur', onBlur);
          });
        };
      }
    </script>
  </body>
</html>

<style>
  /* Custom scrollbar styles */
  .scrollbar-thin {
    scrollbar-width: thin;
  }
  .scrollbar-thumb-neutral-700::-webkit-scrollbar-thumb {
    background-color: rgb(64 64 64);
  }
  .scrollbar-track-neutral-900::-webkit-scrollbar-track {
    background-color: rgb(23 23 23);
  }
  .scrollbar-thin::-webkit-scrollbar {
    width: 8px;
  }
  .scrollbar-thin::-webkit-scrollbar-thumb {
    background-color: rgb(64 64 64);
  }
  .scrollbar-thin::-webkit-scrollbar-track {
    background-color: rgb(23 23 23);
  }

  /* Smooth scrolling */
  html {
    scroll-behavior: smooth;
  }

  /* Screen reader only class */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  .focus\:not-sr-only:focus {
    position: static;
    width: auto;
    height: auto;
    padding: inherit;
    margin: inherit;
    overflow: visible;
    clip: auto;
    white-space: normal;
  }

  /* View Transitions - Simplificadas */
  @view-transition {
    navigation: auto;
  }

  /* Transiciones suaves y simples */
  ::view-transition-old(root),
  ::view-transition-new(root) {
    animation-duration: 0.2s;
    animation-timing-function: ease-in-out;
  }

  ::view-transition-old(root) {
    animation-name: fade-out;
  }

  ::view-transition-new(root) {
    animation-name: fade-in;
  }

  @keyframes fade-out {
    from { opacity: 1; }
    to { opacity: 0.8; }
  }

  @keyframes fade-in {
    from { opacity: 0.8; }
    to { opacity: 1; }
  }

  /* Lazy loading placeholder */
  img[data-src] {
    background: linear-gradient(90deg, #262626 25%, #404040 50%, #262626 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
  }

  @keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .bg-neutral-950 {
      background-color: #000000;
    }
    .text-neutral-300 {
      color: #ffffff;
    }
    .border-neutral-700 {
      border-color: #ffffff;
    }
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    html {
      scroll-behavior: auto;
    }
    
    *,
    ::view-transition-old(*),
    ::view-transition-new(*) {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }

    img[data-src] {
      animation: none;
    }
  }

  /* Focus visible for better keyboard navigation */
  .focus\:outline-none:focus-visible {
    outline: 2px solid white;
    outline-offset: 2px;
  }

  /* Menu transitions */
  #full-menu {
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }

  /* Smooth icon transitions */
  #menu-icon,
  #close-icon {
    transition: opacity 0.2s ease-in-out;
  }

  /* Prefetch hint styling */
  a[data-prefetched] {
    position: relative;
  }

  a[data-prefetched]::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    opacity: 0;
    animation: prefetch-hint 0.3s ease-in-out;
  }

  @keyframes prefetch-hint {
    0%, 100% { opacity: 0; }
    50% { opacity: 1; }
  }
</style>
