---
import Layout from '../layouts/Layout.astro';
import { getIdeas } from '../lib/ideas';

const ideas = await getIdeas();
const url = new URL(Astro.request.url);
const success = url.searchParams.get('success');
const error = url.searchParams.get('error');

const messages = {
  success: {
    created: 'La idea se creó correctamente en el entorno actual.'
  },
  error: {
    'write-protected': 'No se pudo crear la idea en producción porque el filesystem de Vercel es de solo lectura. Crea el contenido en desarrollo o mediante preview, y súbelo al repositorio.',
    unexpected: 'No se pudo crear la idea. Inténtalo de nuevo o revisa los logs del servidor.'
  }
};

const successMessage = success && success in messages.success
  ? messages.success[success as keyof typeof messages.success]
  : null;

const errorMessage = error && error in messages.error
  ? messages.error[error as keyof typeof messages.error]
  : null;
---

<Layout title="Ideas - Muga OS" description="Gestión de ideas y proyectos en Muga OS">
  <section class="px-6 py-20">
    <div class="text-center">
      <h1 class="text-3xl md:text-4xl font-bold text-white mb-6 uppercase tracking-wide">
        Ideas
      </h1>
      <p class="text-lg text-neutral-300 max-w-2xl mx-auto mb-8 leading-relaxed">
        Gestión y seguimiento de ideas y proyectos
      </p>
      {successMessage && (
        <div class="max-w-2xl mx-auto mb-8 bg-emerald-900/30 border border-emerald-700 text-emerald-200 px-6 py-4 text-sm leading-relaxed">
          {successMessage}
        </div>
      )}
      {errorMessage && (
        <div class="max-w-2xl mx-auto mb-8 bg-amber-900/30 border border-amber-700 text-amber-100 px-6 py-4 text-sm leading-relaxed">
          {errorMessage}
        </div>
      )}
      <a
        href="/ideas/new"
        class="inline-block bg-white text-black px-8 py-3 hover:bg-neutral-200 transition-colors font-medium text-sm uppercase tracking-wide"
      >
        Nueva Idea
      </a>
    </div>
  </section>

      {ideas && ideas.length > 0 ? (
        <div class="grid gap-6">
          {ideas.map((idea) => (
            <article class="bg-neutral-900/20 border border-neutral-800 p-6 hover:bg-neutral-900/70 transition-colors">
              <div class="flex items-start justify-between mb-4">
                <div class="flex-1">
                  {idea.data.area && (
                    <div class="mb-3">
                      <span class="bg-neutral-800/60 text-neutral-300 px-3 py-1 text-sm uppercase tracking-wide inline-block">
                        {idea.data.area}
                      </span>
                    </div>
                  )}

                  <div class="flex items-center gap-3 mb-3">
                    <h2 class="text-2xl font-bold text-white uppercase">
                      <a href={`/ideas/${idea.slug}`} class="hover:text-neutral-300 transition-colors">
                        {idea.data.title}
                      </a>
                    </h2>
                    <div class="flex items-center gap-2">
                      {idea.data.priority && (
                        <span class={`px-2 py-1 text-xs tracking-wide ${
                          idea.data.priority === 'Urgente' ? 'bg-red-600/10 text-red-400' :
                          idea.data.priority === 'Alta' ? 'bg-orange-600/10 text-orange-400' :
                          idea.data.priority === 'Media' ? 'bg-yellow-600/10 text-yellow-400' :
                          'bg-neutral-600/10 text-neutral-400'
                        }`}>
                          {idea.data.priority.toLowerCase()}
                        </span>
                      )}
                      <span class={`px-2 py-1 text-xs tracking-wide ${
                        idea.data.status === 'Idea' ? 'bg-blue-600/10 text-blue-400' :
                        idea.data.status === 'Planificación' ? 'bg-purple-600/10 text-purple-400' :
                        idea.data.status === 'En desarrollo' ? 'bg-green-600/10 text-green-400' :
                        idea.data.status === 'Completado' ? 'bg-emerald-600/10 text-emerald-400' :
                        'bg-neutral-600/10 text-neutral-400'
                      }`}>
                        {idea.data.status.toLowerCase()}
                      </span>
                    </div>
                  </div>

                  {idea.data.description && (
                    <p class="text-neutral-300 mb-4 line-clamp-2">{idea.data.description}</p>
                  )}

                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4 text-sm">
                      <a
                        href={`/ideas/edit/${idea.slug}`}
                        class="text-neutral-400 hover:text-white transition-colors font-medium text-sm uppercase tracking-wide"
                      >
                        Editar
                      </a>
                    </div>
                  </div>
                </div>

                {idea.data.date && !isNaN(idea.data.date.getTime()) && (
                  <div class="ml-6">
                    <time class="inline-block bg-neutral-800 text-white px-4 py-2 text-lg font-bold uppercase tracking-wider border border-neutral-700">
                      {idea.data.date.toLocaleDateString('es-ES', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                      })}
                    </time>
                  </div>
                )}
              </div>

              {idea.data.progress > 0 && (
                <div class="mt-4">
                  <div class="flex items-center justify-between text-sm mb-2">
                    <span class="text-neutral-400">Progreso</span>
                    <span class="text-neutral-400">{idea.data.progress}%</span>
                  </div>
                  <div class="w-full bg-neutral-800 h-3 relative overflow-hidden">
                    <div
                      class="progress-fill h-3 transition-all duration-300"
                      style={`width: ${idea.data.progress}%`}
                    ></div>
                  </div>
                </div>
              )}
            </article>
          ))}
        </div>
      ) : (
        <div class="text-center py-16">
          <div class="diagonal-stripes bg-neutral-900/40 p-12 border border-neutral-800/60 max-w-2xl mx-auto">
            <h2 class="text-xl font-semibold text-neutral-300 mb-2 uppercase tracking-wide">
              Sin Ideas
            </h2>
            <p class="text-neutral-500 text-sm mb-6">
              No hay ideas registradas aún. Crea tu primera idea para comenzar.
            </p>
            <a
              href="/ideas/new"
              class="inline-block bg-white text-black px-6 py-3 hover:bg-neutral-200 transition-colors font-medium text-sm uppercase tracking-wide"
            >
              Crear Primera Idea
            </a>
          </div>
        </div>
      )}
    </div>
  </section>
</Layout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .diagonal-stripes {
    background-image: repeating-linear-gradient(
      -45deg,
      transparent,
      transparent 1px,
      rgba(115, 115, 115, 0.1) 3px,
      rgba(115, 115, 115, 0.1) 10px
    );
  }

  .progress-fill {
    background-image: repeating-linear-gradient(
      -45deg,
      transparent,
      transparent 1px,
      rgba(115, 115, 115, 0.3) 3px,
      rgba(115, 115, 115, 0.3) 10px
    );
    background-color: rgba(255, 255, 255, 0.1);
  }
</style>