---
// Página individual del blog refactorizada con TOC lateral
import Layout from "../../layouts/Layout.astro";
import Typography from "../../components/ui/Typography.astro";
import Button from "../../components/ui/Button.astro";
import { getBlogPosts } from "../../lib/blog";

export async function getStaticPaths() {
  const posts = await getBlogPosts();
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;

const tags = Array.isArray(post.data.tags) ? post.data.tags : [];
const categories = Array.isArray(post.data.category) ? post.data.category : [];
---

<Layout
  title={`${post.data.title} - Blog`}
  description={`${post.data.title} - Artículo del blog de MUGA OS`}
  type="article"
  image={post.data.image}
>
  <article class="max-w-6xl mx-auto relative">
    <!-- Header -->
    <header class="px-8 border-b border-neutral-800/50">
      <Button
        href="/blog"
        variant="ghost"
        size="sm"
        class="mb-4"
        ariaLabel="Volver al blog principal"
      >
        ← Volver al blog
      </Button>

      <div class="flex items-center gap-3 mb-10">
        {
          post.data.area && (
            <span class="bg-neutral-800 text-neutral-300 px-4 py-2 text-sm uppercase tracking-wide border border-neutral-700">
              {post.data.area}
            </span>
          )
        }

        {
          categories.length > 0 && (
            <span class="bg-neutral-700 text-neutral-400 px-4 py-2 text-sm uppercase tracking-wide border border-neutral-600">
              {categories[0]}
            </span>
          )
        }

        {
          post.data.status && post.data.status !== "Publicado" && (
            <span class="bg-neutral-600 text-neutral-500 px-4 py-2 text-sm uppercase tracking-wide">
              {post.data.status}
            </span>
          )
        }
      </div>

      <Typography as="h1" variant="title" class="mb-12 leading-tight max-w-4xl">
        {post.data.title}
      </Typography>

      {
        tags.length > 0 && (
          <div class="flex gap-4 mb-1">
            {tags.slice(0, 5).map((tag) => (
              <span class="text-neutral-500 text-xs uppercase tracking-wide">
                #{tag}
              </span>
            ))}
          </div>
        )
      }

      {
        post.data.date instanceof Date && !isNaN(post.data.date.getTime()) && (
          <time class="block text-neutral-400 text-xs uppercase tracking-wide mb-2">
            {post.data.date.toLocaleDateString("es-ES", {
              day: "numeric",
              month: "long",
              year: "numeric",
            })}
          </time>
        )
      }
    </header>

    <!-- Contenido + Índice -->
    <div class="grid grid-cols-1 lg:grid-cols-[1fr_12rem] gap-8 px-8 py-12">
      <!-- Contenido principal -->
      <div class="bg-neutral-800/10 py-10">
        <div class="article-content max-w-prose mx-auto px-6">
          <div set:html={post.body} />
        </div>
      </div>

      <!-- Índice lateral -->
      <aside class="hidden lg:block sticky top-8 self-start">
        <Typography
          as="h3"
          variant="subheading"
          class="mb-6 uppercase tracking-wide text-sm"
        >
          Índice
        </Typography>
        <nav>
          <ol class="space-y-3 text-sm">
            <li><a class="toc-link" href="#objetivo">Objetivo del día</a></li>
            <li>
              <a class="toc-link" href="#criterios-muga">Criterios MUGA</a>
            </li>
            <li><a class="toc-link" href="#idea-base">Idea base</a></li>
            <li><a class="toc-link" href="#pasos">Paso a paso</a></li>
            <li><a class="toc-link" href="#ajuste-grano">Ajuste fino</a></li>
            <li><a class="toc-link" href="#validacion">Validación</a></li>
            <li><a class="toc-link" href="#errores">Errores comunes</a></li>
            <li><a class="toc-link" href="#variaciones">Variaciones</a></li>
            <li><a class="toc-link" href="#export">Checklist</a></li>
          </ol>
        </nav>
      </aside>
    </div>

    <!-- Footer -->
    <footer class="px-8 py-24 border-t border-neutral-800/50 text-center">
      <Button
        href="/blog"
        variant="primary"
        size="lg"
        ariaLabel="Ver más artículos del blog"
      >
        Ver más artículos
      </Button>
    </footer>
  </article>

  <script lang="ts">
    // TOC functionality
    document.addEventListener("DOMContentLoaded", () => {
      const headings = document.querySelectorAll(".article-content h2[id]");
      const links = document.querySelectorAll(".toc-link");

      function syncTOC() {
        let current = undefined;

        headings.forEach((h) => {
          const htmlH = h;
          if (window.scrollY >= htmlH.offsetTop - 100) {
            current = htmlH.id;
          }
        });

        links.forEach((link) => {
          link.classList.toggle(
            "is-active",
            link.getAttribute("href") === `#${current}`
          );
        });
      }

      // Smooth scroll for TOC links
      links.forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          const targetId = link.getAttribute("href")?.substring(1);
          const targetElement = document.getElementById(targetId || "");

          if (targetElement) {
            targetElement.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
          }
        });
      });

      window.addEventListener("scroll", syncTOC);
      syncTOC();
    });
  </script>

  <style>
    /* Estilos para el contenido del artículo */
    .article-content {
      @apply text-neutral-300 leading-relaxed;
    }

    .article-content h2 {
      @apply text-2xl font-bold text-white mt-24 mb-10 uppercase tracking-wide;
    }

    .article-content h3 {
      @apply text-lg font-semibold text-neutral-200 mt-16 mb-8;
    }

    .article-content p {
      @apply mb-8 text-lg leading-relaxed;
    }

    .article-content img {
      @apply w-full my-12 border border-neutral-700;
    }

    .article-content ul,
    .article-content ol {
      @apply mb-8;
    }

    .article-content li {
      @apply mb-3;
    }

    .article-content section {
      @apply mb-20;
    }

    .article-content strong {
      @apply text-white;
    }

    .article-content em {
      @apply text-neutral-200;
    }

    .article-content code {
      @apply bg-neutral-700 px-2 py-1 text-neutral-200;
    }

    .article-content aside {
      @apply bg-neutral-800 p-6 my-8 border-l-4 border-neutral-600;
    }

    .article-content figure {
      @apply my-12;
    }

    .article-content figcaption {
      @apply text-neutral-400 text-sm mt-4 italic;
    }

    /* Estilos para la TOC */
    .toc-link {
      @apply block text-neutral-500 transition-colors py-1 border-l-2 border-transparent pl-3;
    }

    .toc-link:hover {
      @apply text-white border-neutral-600;
    }

    /* El estado activo tiene los mismos estilos que hover */
    .toc-link.is-active {
      @apply text-white border-white;
    }
  </style>
</Layout>
