---
// Página individual del blog con TOC minimal inspirado en Supabase
import Layout from "../../layouts/Layout.astro";
import Typography from "../../components/ui/Typography.astro";
import Button from "../../components/ui/Button.astro";
import TOC from "../../components/ui/TOC.astro";
import type { TocHeading } from "../../components/ui/TOC.astro";
import { getBlogPosts } from "../../lib/blog";

const extractHeadings = (html: string): TocHeading[] => {
  const headingPattern = /<h([23])[^>]*id="([^"]+)"[^>]*>(.*?)<\/h\1>/gis;
  const stripHtml = (value: string) => value.replace(/<[^>]*>/g, "").trim();

  return Array.from(html.matchAll(headingPattern)).map((match) => ({
    id: match[2],
    text: stripHtml(match[3]),
    level: Number(match[1]) as 2 | 3,
  }));
};

export async function getStaticPaths() {
  const posts = await getBlogPosts();
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;

const tags = Array.isArray(post.data.tags) ? post.data.tags : [];
const categories = Array.isArray(post.data.category) ? post.data.category : [];
const headings = extractHeadings(post.body);
---

<Layout
  title={`${post.data.title} - Blog`}
  description={`${post.data.title} - Artículo del blog de MUGA OS`}
  type="article"
  image={post.data.image}
>
  <article class="max-w-6xl mx-auto relative">
    <!-- Header -->
    <header class="px-8 border-b border-neutral-800/50">
      <Button
        href="/blog"
        variant="ghost"
        size="sm"
        class="mb-4"
        ariaLabel="Volver al blog principal"
      >
        ← Volver al blog
      </Button>

      <div class="flex items-center gap-3 mb-10">
        {
          post.data.area && (
            <span class="bg-neutral-800 text-neutral-300 px-4 py-2 text-sm uppercase tracking-wide border border-neutral-700">
              {post.data.area}
            </span>
          )
        }

        {
          categories.length > 0 && (
            <span class="bg-neutral-700 text-neutral-400 px-4 py-2 text-sm uppercase tracking-wide border border-neutral-600">
              {categories[0]}
            </span>
          )
        }

        {
          post.data.status && post.data.status !== "Publicado" && (
            <span class="bg-neutral-600 text-neutral-500 px-4 py-2 text-sm uppercase tracking-wide">
              {post.data.status}
            </span>
          )
        }
      </div>

      <Typography as="h1" variant="title" class="mb-12 leading-tight max-w-4xl">
        {post.data.title}
      </Typography>

      {
        tags.length > 0 && (
          <div class="flex gap-4 mb-1">
            {tags.slice(0, 5).map((tag) => (
              <span class="text-neutral-500 text-xs uppercase tracking-wide">
                #{tag}
              </span>
            ))}
          </div>
        )
      }

      {
        post.data.date instanceof Date && !isNaN(post.data.date.getTime()) && (
          <time class="block text-neutral-400 text-xs uppercase tracking-wide mb-2">
            {post.data.date.toLocaleDateString("es-ES", {
              day: "numeric",
              month: "long",
              year: "numeric",
            })}
          </time>
        )
      }
    </header>

    <!-- Contenido + Índice -->
    <div class="grid grid-cols-1 lg:grid-cols-[1fr_240px] gap-8 px-8 py-12">
      <!-- Contenido principal -->
      <div class="bg-neutral-800/10 py-10">
        <div class="article-content max-w-prose mx-auto px-6">
          <div set:html={post.body} />
        </div>
      </div>

      <!-- Índice lateral -->
      <TOC headings={headings} />
      <aside class="hidden lg:block sticky top-8 self-start">
        <Typography
          as="h3"
          variant="subheading"
          class="mb-4 uppercase tracking-wide text-sm"
        >
          Índice
        </Typography>

        <nav class="toc" aria-label="Tabla de contenidos">
          <ol class="toc-list" role="list">
            <li><a class="toc-link" href="#objetivo">Objetivo del día</a></li>
            <li>
              <a class="toc-link" href="#criterios-muga">Criterios MUGA</a>
            </li>
            <li><a class="toc-link" href="#idea-base">Idea base</a></li>
            <li><a class="toc-link" href="#pasos">Paso a paso</a></li>
            <li><a class="toc-link" href="#ajuste-grano">Ajuste fino</a></li>
            <li><a class="toc-link" href="#validacion">Validación</a></li>
            <li><a class="toc-link" href="#errores">Errores comunes</a></li>
            <li><a class="toc-link" href="#variaciones">Variaciones</a></li>
            <li><a class="toc-link" href="#export">Checklist</a></li>
          </ol>
        </nav>
      </aside>
    </div>

    <!-- Footer -->
    <footer class="px-8 py-24 border-t border-neutral-800/50 text-center">
      <Button
        href="/blog"
        variant="primary"
        size="lg"
        ariaLabel="Ver más artículos del blog"
      >
        Ver más artículos
      </Button>
    </footer>
  </article>

  <script lang="ts">
    // TOC functionality
    document.addEventListener("DOMContentLoaded", () => {
      const headings = Array.from(
        document.querySelectorAll<HTMLElement>(".article-content h2[id]")
      );
      const links = Array.from(
        document.querySelectorAll<HTMLAnchorElement>(".toc-link")
      );

      const setActive = (id?: string) => {
        links.forEach((link) => {
          const match = link.getAttribute("href") === `#${id}`;
          link.classList.toggle("is-active", match);
          link.toggleAttribute("aria-current", match);
        });
      };

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (!entry.target.id) return;
            if (entry.isIntersecting) {
              setActive(entry.target.id);
            }
          });
        },
        {
          rootMargin: "-45% 0px -45% 0px",
          threshold: 0.2,
        }
      );

      headings.forEach((heading) => observer.observe(heading));
      if (headings[0]?.id) {
        setActive(headings[0].id);
      }

      // Smooth scroll for TOC links
      links.forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          const targetId = link.getAttribute("href")?.substring(1);
          const targetElement = targetId
            ? document.getElementById(targetId)
            : null;

          if (targetElement) {
            targetElement.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
            setActive(targetId);
          }
        });
      });
    });
  </script>

  <style>
    /* Estilos para el contenido del artículo */
    .article-content {
      @apply text-neutral-300 leading-relaxed;
    }

    .article-content h2 {
      @apply text-2xl font-bold text-white mt-24 mb-10 uppercase tracking-wide;
    }

    .article-content h3 {
      @apply text-lg font-semibold text-neutral-200 mt-16 mb-8;
    }

    .article-content p {
      @apply mb-8 text-lg leading-relaxed;
    }

    .article-content img {
      @apply w-full my-12 border border-neutral-700;
    }

    .article-content ul,
    .article-content ol {
      @apply mb-8;
    }

    .article-content li {
      @apply mb-3;
    }

    .article-content section {
      @apply mb-20;
    }

    .article-content strong {
      @apply text-white;
    }

    .article-content em {
      @apply text-neutral-200;
    }

    .article-content code {
      @apply bg-neutral-700 px-2 py-1 text-neutral-200;
    }

    .article-content aside {
      @apply bg-neutral-800 p-6 my-8 border-l-4 border-neutral-600;
    }

    .article-content figure {
      @apply my-12;
    }

    .article-content figcaption {
      @apply text-neutral-400 text-sm mt-4 italic;
    }

    /* Estilos para la TOC */
    :root {
      --toc-accent: #FF5353;
    }

    .toc {
      @apply bg-neutral-900/70 border border-neutral-800 rounded-lg p-4 shadow-lg;
    }

    .toc-list {
      @apply space-y-1 pl-4 relative;
    }

    .toc-list::before {
      content: "";
      position: absolute;
      left: 0.5rem;
      top: 0.35rem;
      bottom: 0.35rem;
      width: 2px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.02));
    }

    .toc-link {
      @apply block text-neutral-500 transition-colors py-2 pl-4 relative rounded-md;
      border-left: 2px solid transparent;
    }

    .toc-link::before {
      content: "";
      position: absolute;
      left: 0.2rem;
      top: 50%;
      width: 8px;
      height: 8px;
      border-radius: 9999px;
      background: rgba(255, 255, 255, 0.12);
      transform: translateY(-50%);
      transition: all 150ms ease;
    }

    .toc-link:hover {
      color: #f7f7f7;
      border-left-color: rgba(255, 255, 255, 0.08);
    }

    .toc-link.is-active {
      color: var(--toc-accent);
      font-weight: 600;
      border-left-color: var(--toc-accent);
      background: linear-gradient(90deg, rgba(255, 83, 83, 0.12), transparent);
    }

    .toc-link.is-active::before {
      background: var(--toc-accent);
      box-shadow: 0 0 0 4px rgba(255, 83, 83, 0.15);
      width: 10px;
      height: 10px;
    }
  </style>
</Layout>
