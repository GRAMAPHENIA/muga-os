---
// Página individual del blog con TOC minimal inspirado en Supabase
import Layout from "../../layouts/Layout.astro";
import Typography from "../../components/ui/Typography.astro";
import Button from "../../components/ui/Button.astro";
import TOC from "../../components/ui/TOC.astro";
import type { TocHeading } from "../../components/ui/TOC.astro";
import { getBlogPosts } from "../../lib/blog";

const extractHeadings = (html: string): TocHeading[] => {
  const headingPattern = /<h([23])[^>]*id="([^"]+)"[^>]*>(.*?)<\/h\1>/gis;
  const stripHtml = (value: string) => value.replace(/<[^>]*>/g, "").trim();

  return Array.from(html.matchAll(headingPattern)).map((match) => ({
    id: match[2],
    text: stripHtml(match[3]),
    level: Number(match[1]) as 2 | 3,
  }));
};

export async function getStaticPaths() {
  const posts = await getBlogPosts();
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;

const tags = Array.isArray(post.data.tags) ? post.data.tags : [];
const categories = Array.isArray(post.data.category) ? post.data.category : [];
const headings = extractHeadings(post.body);
---

<Layout
  title={`${post.data.title} - Blog`}
  description={`${post.data.title} - Artículo del blog de MUGA OS`}
  type="article"
  image={post.data.image}
>
  <article class="max-w-6xl mx-auto relative">
    <!-- Header -->
    <header class="px-8 border-b border-neutral-800/50">
      <Button
        href="/blog"
        variant="ghost"
        size="sm"
        class="mb-4"
        ariaLabel="Volver al blog principal"
      >
        ← Volver al blog
      </Button>

      <div class="flex items-center gap-3 mb-10">
        {
          post.data.area && (
            <span class="bg-neutral-800 text-neutral-300 px-4 py-2 text-sm uppercase tracking-wide border border-neutral-700">
              {post.data.area}
            </span>
          )
        }

        {
          categories.length > 0 && (
            <span class="bg-neutral-700 text-neutral-400 px-4 py-2 text-sm uppercase tracking-wide border border-neutral-600">
              {categories[0]}
            </span>
          )
        }

        {
          post.data.status && post.data.status !== "Publicado" && (
            <span class="bg-neutral-600 text-neutral-500 px-4 py-2 text-sm uppercase tracking-wide">
              {post.data.status}
            </span>
          )
        }
      </div>

      <Typography as="h1" variant="title" class="mb-12 leading-tight max-w-4xl">
        {post.data.title}
      </Typography>

      {
        tags.length > 0 && (
          <div class="flex gap-4 mb-1">
            {tags.slice(0, 5).map((tag) => (
              <span class="text-neutral-500 text-xs uppercase tracking-wide">
                #{tag}
              </span>
            ))}
          </div>
        )
      }

      {
        post.data.date instanceof Date && !isNaN(post.data.date.getTime()) && (
          <time class="block text-neutral-400 text-xs uppercase tracking-wide mb-2">
            {post.data.date.toLocaleDateString("es-ES", {
              day: "numeric",
              month: "long",
              year: "numeric",
            })}
          </time>
        )
      }
    </header>

    <!-- Contenido + Índice -->
    <div class="grid grid-cols-1 lg:grid-cols-[1fr_240px] gap-8 px-8 py-12">
      <!-- Contenido principal -->
      <div class="bg-neutral-800/10 py-10">
        <div class="article-content max-w-prose mx-auto px-6">
          <div set:html={post.body} />
        </div>
      </div>

      <!-- Índice lateral -->
      <TOC headings={headings} />
    </div>

    <!-- Footer -->
    <footer class="px-8 py-24 border-t border-neutral-800/50 text-center">
      <Button
        href="/blog"
        variant="primary"
        size="lg"
        ariaLabel="Ver más artículos del blog"
      >
        Ver más artículos
      </Button>
    </footer>
  </article>

  <style>
    /* Estilos para el contenido del artículo */
    .article-content {
      @apply text-neutral-300 leading-relaxed;
    }

    .article-content h2 {
      @apply text-2xl font-bold text-white mt-24 mb-10 uppercase tracking-wide;
    }

    .article-content h3 {
      @apply text-lg font-semibold text-neutral-200 mt-16 mb-8;
    }

    .article-content p {
      @apply mb-8 text-lg leading-relaxed;
    }

    .article-content img {
      @apply w-full my-12 border border-neutral-700;
    }

    .article-content ul,
    .article-content ol {
      @apply mb-8;
    }

    .article-content li {
      @apply mb-3;
    }

    .article-content section {
      @apply mb-20;
    }

    .article-content strong {
      @apply text-white;
    }

    .article-content em {
      @apply text-neutral-200;
    }

    .article-content code {
      @apply bg-neutral-700 px-2 py-1 text-neutral-200;
    }

    .article-content aside {
      @apply bg-neutral-800 p-6 my-8 border-l-4 border-neutral-600;
    }

    .article-content figure {
      @apply my-12;
    }

    .article-content figcaption {
      @apply text-neutral-400 text-sm mt-4 italic;
    }
  </style>
</Layout>
