---
export async function getStaticPaths() {
  const { getCollection } = await import('astro:content');
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;

// Parse content to extract sections
const content = post.body || '';
const lines = content.split('\n');

// Extract sections
let introduccion = '';
let mainContent = '';
let conclusion = '';

let currentSection = '';
for (const line of lines) {
  if (line.startsWith('## Introducción')) {
    currentSection = 'intro';
  } else if (line.startsWith('## Desarrollo')) {
    currentSection = 'content';
  } else if (line.startsWith('## Conclusión')) {
    currentSection = 'conclusion';
  } else if (line.startsWith('---')) {
    // Skip separators
  } else if (line.startsWith('### ') && currentSection === 'content') {
    // Skip subsection headers
  } else if (line.trim() && !line.startsWith('![') && !line.startsWith('# ')) {
    if (currentSection === 'intro') {
      introduccion += line + '\n';
    } else if (currentSection === 'content') {
      mainContent += line + '\n';
    } else if (currentSection === 'conclusion') {
      conclusion += line + '\n';
    }
  }
}

// Clean up content
introduccion = introduccion.trim();
mainContent = mainContent.trim();
conclusion = conclusion.trim();
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Editar: {post.data.title} - Muga OS</title>
  </head>
  <body class="bg-black text-white min-h-screen">
    <div class="max-w-4xl mx-auto px-6 py-8">
      <!-- Header -->
      <div class="mb-8">
        <a
          href="/blog"
          class="inline-flex items-center text-neutral-400 hover:text-white text-sm font-medium uppercase tracking-wide mb-4"
        >
          ← Volver al blog
        </a>
        <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">
          Editar: {post.data.title}
        </h1>
        <p class="text-neutral-400">
          Modifica el contenido del post y guarda los cambios.
        </p>
      </div>

      <!-- Form -->
      <form id="editForm" action="/api/update-post" method="POST" enctype="multipart/form-data" class="space-y-6">
        <input type="hidden" name="slug" value={post.slug} />

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="titulo" class="block text-sm font-medium text-neutral-300 mb-2">
              Título *
            </label>
            <input
              type="text"
              id="titulo"
              name="titulo"
              required
              value={post.data.title}
              class="w-full px-4 py-3 bg-neutral-900 border border-neutral-700 text-white placeholder-neutral-500 focus:border-white focus:outline-none"
            />
          </div>

          <div>
            <label for="estado" class="block text-sm font-medium text-neutral-300 mb-2">
              Estado *
            </label>
            <select
              id="estado"
              name="estado"
              required
              class="w-full px-4 py-3 bg-neutral-900 border border-neutral-700 text-white focus:border-white focus:outline-none"
            >
              <option value="Borrador" selected={post.data.status === 'Borrador'}>Borrador</option>
              <option value="Publicado" selected={post.data.status === 'Publicado'}>Publicado</option>
              <option value="Archivado" selected={post.data.status === 'Archivado'}>Archivado</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="area" class="block text-sm font-medium text-neutral-300 mb-2">
              Área
            </label>
            <select
              id="area"
              name="area"
              class="w-full px-4 py-3 bg-neutral-900 border border-neutral-700 text-white focus:border-white focus:outline-none"
            >
              <option value="">Seleccionar área</option>
              <option value="Studio" selected={post.data.area === 'Studio'}>Studio</option>
              <option value="Dev" selected={post.data.area === 'Dev'}>Dev</option>
            </select>
          </div>

          <div>
            <label for="categoria" class="block text-sm font-medium text-neutral-300 mb-2">
              Categoría
            </label>
            <select
              id="categoria"
              name="categoria"
              class="w-full px-4 py-3 bg-neutral-900 border border-neutral-700 text-white focus:border-white focus:outline-none"
            >
              <option value="">Seleccionar categoría</option>
              <option value="Tutorial" selected={post.data.category?.includes('Tutorial')}>Tutorial</option>
              <option value="Proyecto" selected={post.data.category?.includes('Proyecto')}>Proyecto</option>
              <option value="Reflexión" selected={post.data.category?.includes('Reflexión')}>Reflexión</option>
              <option value="Astro" selected={post.data.category?.includes('Astro')}>Astro</option>
              <option value="Blender" selected={post.data.category?.includes('Blender')}>Blender</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="fecha" class="block text-sm font-medium text-neutral-300 mb-2">
              Fecha *
            </label>
            <input
              type="date"
              id="fecha"
              name="fecha"
              required
              value={post.data.date && !isNaN(post.data.date.getTime()) ? post.data.date.toISOString().split('T')[0] : new Date().toISOString().split('T')[0]}
              class="w-full px-4 py-3 bg-neutral-900 border border-neutral-700 text-white focus:border-white focus:outline-none"
            />
          </div>

          <div>
            <label for="tags" class="block text-sm font-medium text-neutral-300 mb-2">
              Tags (separados por coma)
            </label>
            <input
              type="text"
              id="tags"
              name="tags"
              value={post.data.tags?.join(', ') || ''}
              class="w-full px-4 py-3 bg-neutral-900 border border-neutral-700 text-white placeholder-neutral-500 focus:border-white focus:outline-none"
            />
          </div>
        </div>

        <div>
          <label for="introduccion" class="block text-sm font-medium text-neutral-300 mb-2">
            Introducción
          </label>
          <textarea
            id="introduccion"
            name="introduccion"
            rows="3"
            class="w-full px-4 py-3 bg-neutral-900 border border-neutral-700 text-white placeholder-neutral-500 focus:border-white focus:outline-none"
          >{introduccion}</textarea>
        </div>

        <div>
          <label for="contenido" class="block text-sm font-medium text-neutral-300 mb-2">
            Contenido Principal
          </label>
          <textarea
            id="contenido"
            name="contenido"
            rows="6"
            class="w-full px-4 py-3 bg-neutral-900 border border-neutral-700 text-white placeholder-neutral-500 focus:border-white focus:outline-none"
          >{mainContent}</textarea>
        </div>

        <div>
          <label for="conclusion" class="block text-sm font-medium text-neutral-300 mb-2">
            Conclusión
          </label>
          <textarea
            id="conclusion"
            name="conclusion"
            rows="3"
            class="w-full px-4 py-3 bg-neutral-900 border border-neutral-700 text-white placeholder-neutral-500 focus:border-white focus:outline-none"
          >{conclusion}</textarea>
        </div>

        <div>
          <label for="imagen_destacada" class="block text-sm font-medium text-neutral-300 mb-2">
            Nueva Imagen Destacada (opcional)
          </label>
          <input
            type="file"
            id="imagen_destacada"
            name="imagen_destacada"
            accept="image/*"
            class="w-full px-4 py-3 bg-neutral-900 border border-neutral-700 text-white file:bg-neutral-800 file:border-0 file:px-4 file:py-2 file:text-white file:mr-4 focus:border-white focus:outline-none"
          />
          <p class="text-xs text-neutral-500 mt-1">
            Solo sube una imagen si quieres cambiar la actual.
          </p>
        </div>

        <div class="flex gap-4">
          <button
            type="submit"
            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 transition-colors font-medium text-sm uppercase tracking-wide"
          >
            Guardar Cambios
          </button>
          <a
            href={`/blog/${post.slug}`}
            class="flex-1 text-center bg-neutral-800 text-white px-8 py-3 hover:bg-neutral-700 transition-colors font-medium text-sm uppercase tracking-wide"
          >
            Ver Post
          </a>
          <a
            href="/blog"
            class="flex-1 text-center bg-neutral-600 text-white px-8 py-3 hover:bg-neutral-500 transition-colors font-medium text-sm uppercase tracking-wide"
          >
            Cancelar
          </a>
        </div>
      </form>
    </div>
  </body>
</html>