---
import Typography from "./Typography.astro";

export interface TocHeading {
  id: string;
  text: string;
  level: 2 | 3;
}

interface Props {
  headings: TocHeading[];
}

const { headings } = Astro.props;
---
{headings.length > 0 && (
  <aside class="hidden lg:block w-[240px] sticky top-8 self-start">
    <Typography
      as="h3"
      variant="subheading"
      class="mb-3 uppercase tracking-[0.12em] text-xs text-neutral-500"
    >
      En esta p√°gina
    </Typography>

    <nav aria-label="Tabla de contenidos" class="text-sm text-neutral-400">
      <ol class="relative border-l border-neutral-800">
        {headings.map((heading) => (
          <li
            class={`relative ${
              heading.level === 3 ? "pl-5" : "pl-4"
            } leading-6`}
          >
            <a
              class="toc-link group flex gap-3 py-2 text-neutral-400 no-underline"
              href={`#${heading.id}`}
              data-toc-id={heading.id}
              data-toc-level={heading.level}
            >
              <span
                class="toc-bullet mt-[6px] h-[6px] w-[6px] rounded-full bg-neutral-600"
                aria-hidden="true"
              />
              <span class="flex-1 text-sm">{heading.text}</span>
            </a>
          </li>
        ))}
      </ol>
    </nav>
  </aside>
)}

<script>
  const links = Array.from(
    document.querySelectorAll<HTMLAnchorElement>("[data-toc-id]")
  );
  const headings = Array.from(
    document.querySelectorAll<HTMLElement>(
      ".article-content h2[id], .article-content h3[id]"
    )
  );

  const setActive = (id?: string) => {
    links.forEach((link) => {
      const active = link.dataset.tocId === id;
      link.classList.toggle("toc-active", active);
      link.toggleAttribute("aria-current", active);
    });
  };

  if (headings.length && links.length) {
    const observer = new IntersectionObserver(
      (entries) => {
        const visible = entries
          .filter((entry) => entry.isIntersecting && entry.target.id)
          .sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top);

        if (visible[0]?.target.id) {
          setActive(visible[0].target.id);
        }
      },
      {
        rootMargin: "-40% 0px -40% 0px",
        threshold: 0.1,
      }
    );

    headings.forEach((heading) => observer.observe(heading));
    setActive(headings[0].id);
  }

  links.forEach((link) => {
    link.addEventListener("click", (event) => {
      event.preventDefault();
      const targetId = link.dataset.tocId;
      const target = targetId ? document.getElementById(targetId) : null;

      if (target) {
        target.scrollIntoView({ behavior: "auto", block: "start" });
        setActive(targetId);
      }
    });
  });
</script>

<style>
  .toc-link {
    @apply relative transition-none;
  }

  .toc-link:hover {
    @apply text-neutral-200;
  }

  .toc-active {
    color: #ff5353;
    font-weight: 600;
  }

  .toc-active .toc-bullet {
    background-color: #ff5353;
  }
</style>
